<div class="simditor-body">  <h1>日志设计</h1><h2>概述</h2><ul><li>设计一个日志记录规范，大家在记录日志时按照规范设定格式、等级、内容等信息；</li><li>日志服务器要考虑在内网运行和云端运行两种情况，设计上充分考虑两者的不同之处；</li><li>日志服务应选择不同编程语言通用的方式存储；</li><li>提供查询界面供日志查询；</li></ul><h2>设计</h2><h3>日志等级</h3><p>log4j/log4net的日志等级在实际使用中已经足够，日志等级准备直接使用这些等级。log4j/log4net的日志等级包括：</p><ul><li><code>ALL</code></li><li><code>TRACE</code></li><li><code>DEBUG</code></li><li><code>INFO</code></li><li><code>WARN</code></li><li><code>ERROR</code></li><li><code>FATAL</code></li><li><code>OFF</code></li></ul><p>每条日志必须指定一个以上的<code>level</code>，但不包括其中<code>ALL</code>和<code>OFF</code>（特殊意义）。</p><h4><code>TRACE</code>的使用场景</h4><p>应用在整个执行过程中有一些比较关键的步骤。<code>TRACE</code>等级用于记录程序执行的这些步骤。它比<code>DEBUG</code>记录的信息更细更全面，是所有等级中产生日志数量最多的一个等级。</p><ul><li>从程序员的角度，<code>TRACE</code>可以用于记录你认为对描述程序执行过程<strong>有意义</strong>的所有信息；</li><li>从查看日志的角度，从<code>TRACE</code>日志中应该能够了解程序执行的全貌，以便在出现问题时能够从中找到有用的信息和确定在代码中的大致范围；</li></ul><h4><code>DEBUG</code>的使用场景</h4><p>用于记录应用运行过程中的调试信息，如一些中间状态，重要时间点的各种变量值等。</p><h4><code>INFO</code>的使用场景</h4><p>程序执行过程中的记录的一般性信息，描述执行的大致过程。<br>在云端版本中将使用这个等级作为默认的日志收集等级，只有高于这个等级的日志才会被收集到云端。</p><h4><code>WARN</code>的使用场景</h4><p>当应用中出现了预期外的状况，虽然不会显著影响程序运行，但可能存在潜在风险时，使用这个等级来记录。例如：</p><ul><li>用户为某个变量传入了不适当的取值（预期以外的状况）；</li><li>执行过程中可以用默认值取代（不会显著影响程序运行）；</li><li>（因为并不是按他传入的值执行）最后执行结果可能与用户期望的不符（潜在风险）；<br><code>WARN</code>通常用于记录可能存在的风险。</li></ul><h4><code>ERROR</code></h4><p>当应用中出现了显著的问题，但整体上应用仍可以继续执行时，使用这个等级来记录。<code>ERROR</code>记录的问题较<code>WARN</code>更严重，更应该引起编程人员的注意。例如：</p><ul><li>在网站中某个用户下订单时传入的数据没有要购买的产品（显著的问题）；</li><li>这个用户的请求处理中止，但整个网站仍然在正常运行（应用仍可以继续执行）；</li></ul><h4><code>FATAL</code></h4><p>用于记录最严重的，导致整个应用无法继续执行的问题。<code>FATAL</code>记录的问题比<code>ERROR</code>更严重，例如：</p><ul><li>数据库无法访问磁盘（应用无法继续执行）；</li></ul><p>通常<code>FATAL</code>将是应用存活时最后的日志，输出后应用即结束。</p><h3>必要日志信息</h3><h4>调用Log Miner过程中需要输出的信息</h4><ul><li>连接到Oracle数据库-<code>INFO</code></li><li>连接到Oracle数据库失败-<code>ERROR</code></li><li>重试连接到Oracle数据库-<code>INFO</code></li><li>重试一定次数后仍然无法连接到Oracle数据库-<code>FATAL</code></li><li>连接到MongoDB数据库-<code>INFO</code></li><li>连接到MongoDB数据库失败-<code>ERROR</code></li><li>重试连接到MongoDB数据库-<code>INFO</code></li><li>重试一定次数后仍然无法连接到MongoDB数据库-<code>FATAL</code></li><li>开始快照同步-<code>INFO</code></li><li>开始快照同步时所有未完成事务的最早<code>SCN</code>及其对应的<code>TXNID</code>-<code>DEBUG</code></li><li>读取快照时的任何异常-<code>FATAL</code></li><li>每完成5%时输出一次提示信息-<code>INFO</code><ul><li>比如快照同步10万数据时，每完成5000条时给出一条提示；</li><li>主要目的是在长时间运行过程中让用户知道同步仍在进行；</li></ul></li><li>快照同步完成-<code>INFO</code></li><li>开始增量同步（开始分析<code>Redo Log</code>)-<code>INFO</code></li><li>开始增量同步的起始<code>SCN</code>-<code>DEBUG</code></li><li>增量同步分析<code>Redo Log</code>时一共发现多少文件-<code>DEBUG</code></li><li>当前分析到<code>Redo Log</code>中的哪一个文件，哪一个<code>SCN</code>、<code>RS_ID</code>-<code>DEBUG</code></li><li>分析<code>Redo Log</code>时发现多少条数据需要同步-<code>INFO</code></li><li>当前同步了多少条，考虑每一批数据输出一条日志-<code>INFO</code></li><li>分析过程中的任何错误-<code>ERROR</code></li><li>重试分析<code>Redo log</code>-<code>INFO</code></li><li>分析<code>Redo Log</code>完成-<code>INFO</code></li></ul><h4>日志分析输出的信息</h4><ul><li>连接MongoDB队列数据库-<code>INFO</code></li><li>连接MongoDB目标数据库-<code>INFO</code></li><li>任何时候发生连接错误-<code>ERROR</code></li><li>连接错误时重试-<code>INFO</code></li></ul><h3>日志系统架构</h3><h4>数据结构</h4><pre class="hljs groovy"><code>{
    <span class="hljs-symbol">    logger:</span> <span class="hljs-string">""</span>, <span class="hljs-comment">// 必填。日志属于哪个logger</span>
    <span class="hljs-symbol">    exception:</span> <span class="hljs-string">""</span>, <span class="hljs-comment">// 选填。异常名称，如NullReferenceException</span>
    <span class="hljs-symbol">    message:</span> <span class="hljs-string">""</span>, <span class="hljs-comment">// 必填。写入日志时提供的消息</span>
    <span class="hljs-symbol">    timestamp:</span> ISODate(), <span class="hljs-comment">// 必填。写入日志时间</span>
    <span class="hljs-symbol">    level:</span> <span class="hljs-string">""</span>, <span class="hljs-comment">// 必填。日志等级，WARN, ERROR, ...</span>
    <span class="hljs-symbol">    source:</span> <span class="hljs-string">""</span>, <span class="hljs-comment">// 必填。日志来源服务器</span>
    <span class="hljs-symbol">    stackTrace:</span> <span class="hljs-string">""</span>, <span class="hljs-comment">// 选填。错误堆栈</span>
    <span class="hljs-symbol">    customData:</span> [   <span class="hljs-comment">// 选填。自定义数据</span>
            {<span class="hljs-string">k:</span> <span class="hljs-string">""</span>, <span class="hljs-string">v:</span> <span class="hljs-string">""</span>}
        ]
    }
    </code></pre><p><span style="color:rgb(51, 51, 51); font-size:16px;">（未完待续）</span></p>  </div>